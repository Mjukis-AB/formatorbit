name: Release

permissions:
  contents: write

on:
  push:
    tags:
      - 'v*'

env:
  CARGO_TERM_COLOR: always
  PYO3_USE_ABI3_FORWARD_COMPATIBILITY: 1

jobs:
  publish-crates:
    name: Publish to crates.io
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Publish formatorbit-core
        run: cargo publish -p formatorbit-core --token ${{ secrets.CARGO_REGISTRY_TOKEN }}

      - name: Wait for crates.io to index
        run: sleep 30

      - name: Publish formatorbit-cli
        run: cargo publish -p formatorbit-cli --token ${{ secrets.CARGO_REGISTRY_TOKEN }}

  create-release:
    name: Create Release
    runs-on: ubuntu-latest
    outputs:
      upload_url: ${{ steps.create_release.outputs.upload_url }}
    steps:
      - uses: actions/checkout@v4

      - name: Create Release
        id: create_release
        uses: softprops/action-gh-release@v1
        with:
          draft: false
          prerelease: false
          generate_release_notes: true

  build:
    name: Build (${{ matrix.target }})
    needs: create-release
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - target: x86_64-unknown-linux-gnu
            os: ubuntu-latest
            archive: tar.gz
          - target: x86_64-apple-darwin
            os: macos-latest
            archive: tar.gz
          - target: aarch64-apple-darwin
            os: macos-latest
            archive: tar.gz
          - target: x86_64-pc-windows-msvc
            os: windows-latest
            archive: zip

    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Build
        run: cargo build --release --target ${{ matrix.target }} -p formatorbit-cli

      - name: Package (Unix)
        if: matrix.os != 'windows-latest'
        run: |
          cd target/${{ matrix.target }}/release
          tar -czvf ../../../forb-${{ github.ref_name }}-${{ matrix.target }}.tar.gz forb
          cd ../../..

      - name: Package (Windows)
        if: matrix.os == 'windows-latest'
        run: |
          cd target/${{ matrix.target }}/release
          7z a ../../../forb-${{ github.ref_name }}-${{ matrix.target }}.zip forb.exe
          cd ../../..

      - name: Upload Release Asset
        uses: softprops/action-gh-release@v1
        with:
          files: forb-${{ github.ref_name }}-${{ matrix.target }}.${{ matrix.archive }}

  deb:
    name: Build .deb package
    needs: create-release
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install cargo-deb
        run: cargo install cargo-deb

      - name: Build release
        run: cargo build --release -p formatorbit-cli

      - name: Build .deb
        run: cargo deb -p formatorbit-cli --no-build

      - name: Upload .deb
        uses: softprops/action-gh-release@v1
        with:
          files: target/debian/*.deb

  homebrew:
    name: Update Homebrew
    needs: build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Generate Homebrew formula
        run: |
          VERSION="${{ github.ref_name }}"
          VERSION="${VERSION#v}"

          # Get checksums
          curl -sL "https://github.com/mjukis-ab/formatorbit/releases/download/${{ github.ref_name }}/forb-${{ github.ref_name }}-x86_64-apple-darwin.tar.gz" -o macos-x86.tar.gz
          curl -sL "https://github.com/mjukis-ab/formatorbit/releases/download/${{ github.ref_name }}/forb-${{ github.ref_name }}-aarch64-apple-darwin.tar.gz" -o macos-arm.tar.gz
          curl -sL "https://github.com/mjukis-ab/formatorbit/releases/download/${{ github.ref_name }}/forb-${{ github.ref_name }}-x86_64-unknown-linux-gnu.tar.gz" -o linux.tar.gz

          SHA_MACOS_X86=$(sha256sum macos-x86.tar.gz | cut -d' ' -f1)
          SHA_MACOS_ARM=$(sha256sum macos-arm.tar.gz | cut -d' ' -f1)
          SHA_LINUX=$(sha256sum linux.tar.gz | cut -d' ' -f1)

          cat > forb.rb << EOF
          class Forb < Formula
            desc "CLI tool that shows all possible interpretations of any data input"
            homepage "https://github.com/mjukis-ab/formatorbit"
            version "${VERSION}"
            license "MIT"

            on_macos do
              if Hardware::CPU.arm?
                url "https://github.com/mjukis-ab/formatorbit/releases/download/${{ github.ref_name }}/forb-${{ github.ref_name }}-aarch64-apple-darwin.tar.gz"
                sha256 "${SHA_MACOS_ARM}"
              else
                url "https://github.com/mjukis-ab/formatorbit/releases/download/${{ github.ref_name }}/forb-${{ github.ref_name }}-x86_64-apple-darwin.tar.gz"
                sha256 "${SHA_MACOS_X86}"
              end
            end

            on_linux do
              url "https://github.com/mjukis-ab/formatorbit/releases/download/${{ github.ref_name }}/forb-${{ github.ref_name }}-x86_64-unknown-linux-gnu.tar.gz"
              sha256 "${SHA_LINUX}"
            end

            def install
              bin.install "forb"
            end

            test do
              assert_match "hex", shell_output("#{bin}/forb --formats")
            end
          end
          EOF

      - name: Push to Homebrew tap
        uses: dmnemec/copy_file_to_another_repo_action@main
        env:
          API_TOKEN_GITHUB: ${{ secrets.HOMEBREW_TAP_TOKEN }}
        with:
          source_file: 'forb.rb'
          destination_repo: 'mjukis-ab/homebrew-tap'
          destination_folder: 'Formula'
          user_email: 'github-actions[bot]@users.noreply.github.com'
          user_name: 'github-actions[bot]'
          commit_message: 'Update forb to ${{ github.ref_name }}'

  scoop:
    name: Update Scoop
    needs: build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Generate Scoop manifest
        run: |
          VERSION="${{ github.ref_name }}"
          VERSION="${VERSION#v}"

          curl -sL "https://github.com/mjukis-ab/formatorbit/releases/download/${{ github.ref_name }}/forb-${{ github.ref_name }}-x86_64-pc-windows-msvc.zip" -o windows.zip
          SHA_WINDOWS=$(sha256sum windows.zip | cut -d' ' -f1)

          cat > forb.json << EOF
          {
              "version": "${VERSION}",
              "description": "CLI tool that shows all possible interpretations of any data input",
              "homepage": "https://github.com/mjukis-ab/formatorbit",
              "license": "MIT",
              "architecture": {
                  "64bit": {
                      "url": "https://github.com/mjukis-ab/formatorbit/releases/download/${{ github.ref_name }}/forb-${{ github.ref_name }}-x86_64-pc-windows-msvc.zip",
                      "hash": "${SHA_WINDOWS}"
                  }
              },
              "bin": "forb.exe",
              "checkver": "github",
              "autoupdate": {
                  "architecture": {
                      "64bit": {
                          "url": "https://github.com/mjukis-ab/formatorbit/releases/download/v\$version/forb-v\$version-x86_64-pc-windows-msvc.zip"
                      }
                  }
              }
          }
          EOF

      - name: Push to Scoop bucket
        uses: dmnemec/copy_file_to_another_repo_action@main
        env:
          API_TOKEN_GITHUB: ${{ secrets.HOMEBREW_TAP_TOKEN }}
        with:
          source_file: 'forb.json'
          destination_repo: 'mjukis-ab/scoop-bucket'
          destination_folder: 'bucket'
          user_email: 'github-actions[bot]@users.noreply.github.com'
          user_name: 'github-actions[bot]'
          commit_message: 'Update forb to ${{ github.ref_name }}'
